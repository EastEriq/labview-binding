#==============================================================================
# Makefile to generate the Tango Binding for LabVIEW - NL - SOLEIL
#============================================================================== 

#==============================================================================
# BINDING_ROOT
#==============================================================================
BINDING_ROOT=/home/nicolas/bindings/labview-binding

#==============================================================================
# RUNTIME_ROOT
#==============================================================================
RUNTIME_ROOT=$(BINDING_ROOT)/runtime/linux

#==============================================================================
# RUNTIME_INC
#==============================================================================
RUNTIME_INC=$(RUNTIME_ROOT)/include

#==============================================================================
# RUNTIME_LIB
#==============================================================================
RUNTIME_LIB=$(RUNTIME_ROOT)/lib/x86/tango-9.2.2-gcc-4.3

#==============================================================================
# YAT
#==============================================================================
YAT_ROOT=$(RUNTIME_ROOT)
YAT_INC=$(RUNTIME_INC)
YAT_LIB=$(RUNTIME_LIB)

#==============================================================================
# YAT4TANGO
#==============================================================================
YAT4TANGO_ROOT=$(RUNTIME_ROOT)
YAT4TANGO_INC==$(RUNTIME_INC)
YAT4TANGO_LIB=$(RUNTIME_LIB)

#==============================================================================
# OMNIORB
#==============================================================================
OMNIORB_ROOT=$(RUNTIME_ROOT)
OMNIORB_INC=$(RUNTIME_INC)
OMNIORB_LIB=$(RUNTIME_LIB)

#==============================================================================
# ZMQ
#==============================================================================
ZMQ_ROOT=$(RUNTIME_ROOT)
ZMQ_INC==$(RUNTIME_INC)
ZMQ_LIB=$(RUNTIME_LIB)

#==============================================================================
# TANGO
#==============================================================================
TANGO_ROOT=$(RUNTIME_ROOT)
TANGO_INC=$(RUNTIME_INC)/tango
TANGO_LIB=$(RUNTIME_LIB)

#==============================================================================
# GCC
#==============================================================================
GCC_BIN_DIR=/home/nicolas/gcc-4.3.6/bin
GCC_SUFFIX=-4.3

#==============================================================================
# LABVIEW
#==============================================================================
LABVIEW_ROOT=/usr/local/natinst/LabVIEW-2014

#==============================================================================
# BINDING INSTALL DIR
#==============================================================================
BINDING_VIS=../vis

#==============================================================================
# INCLUDE DIRS
#==============================================================================
INCLUDE_DIRS = -I. \
               -I$(OMNIORB_INC) \
               -I$(TANGO_INC) \
               -I$(ZMQ_INC) \
               -I$(YAT4TANGO_INC) \
               -I$(YAT_INC) \
               -I$(LABVIEW_ROOT)/cintools

#==============================================================================
# LIB DIRS
#==============================================================================
LIB_DIRS = -L. \
           -L$(ZMQ_LIB) \
           -L$(OMNIORB_LIB) \
           -L$(TANGO_LIB) \
           -L$(YAT4TANGO_LIB) \
           -L$(YAT_LIB) \

#==============================================================================
# BINDING SHARED LIB: NAME & EXTENSION
#==============================================================================
LVB_NAME = tango_binding
LVB_EXT = so

#==============================================================================
# COMP$(CC)ILER/LINKER OPTIONS for GNU/LINUX
#==============================================================================
CC=$(GCC_BIN_DIR)/gcc$(GCC_SUFFIX)
CXX=$(GCC_BIN_DIR)/g++$(GCC_SUFFIX)
#------------------------------------------------------------------------------
LVB_LIB_CFLAGS  = -fPIC -D_REENTRANT -O2 -g -gstabs+ -std=c++0x
#------------------------------------------------------------------------------
LVB_CFLAGS = $(LVB_LIB_CFLAGS)
#------------------------------------------------------------------------------
LD=$(GCC_BIN_DIR)/gcc$(GCC_SUFFIX)
#------------------------------------------------------------------------------
LVB_LDFLAGS  = -shared -O -pthread
LVB_LDFLAGS += -Wl,--version-script,tango_binding.map
LVB_LDFLAGS += -Wl,-soname,$(LVB_NAME).$(LVB_EXT)
#------------------------------------------------------------------------------

#==============================================================================
# CURRENT WORKING DIR
#==============================================================================
CWD=$(PWD)

#------------------------------------------------------------------------------
# LIBS for LVB - LIBS ORDER MATTERS! tango before yat4tango!
#------------------------------------------------------------------------------
LVB_LIBS = -ltango \
           -llog4tango \
           -lzmq \
           -lomniDynamic4 \
           -lCOS4 \
           -lomniORB4 \
           -lomnithread \
           -lyat\
           -lyat4tango \
           -lrt \
           -lstdc++
           
#------------------------------------------------------------------------------
# OBJS FILES - FILES ORDER MATTERS! DeviceClassFactory must the first one
#------------------------------------------------------------------------------
LVB_OBJS = ObjectManager.so.o \
           TangoBinding.so.o \
           ThreadSafeDeviceProxy.so.o \
           LvDeviceProxy.so.o \
           LvDeviceProxyRepository.so.o \
           DeviceGroup.so.o \
           DeviceGroupRepository.so.o \
           DataAdapter.so.o \
           Endianness.so.o \
           ErrorStack.so.o \
           EventManager.so.o \
           LvDeviceImpl.so.o \
           LvDeviceClass.so.o \
           LvDeviceClassFactory.so.o \
           LvDevice.so.o \
           LvDeviceRepository.so.o \
           LvDeviceServer.so.o \
           xml/tinyxml2.so.o \
           xml/parser.so.o
           
#------------------------------------------------------------------------------
# RULE for LVB_ .cpp 
#------------------------------------------------------------------------------
.SUFFIXES: .so.o .cpp
.cpp.so.o:
	$(CC) $(LVB_CFLAGS) $(INCLUDE_DIRS) -c -o  $@ $<

#------------------------------------------------------------------------------
# RULE: all
#------------------------------------------------------------------------------
all: release

#------------------------------------------------------------------------------
# RULE: release
#------------------------------------------------------------------------------
release: sym_links build_lvb install

#------------------------------------------------------------------------------
# RULE: release
#------------------------------------------------------------------------------
debug: sym_links build_lvb install

#------------------------------------------------------------------------------
# RULE: sym_links
#------------------------------------------------------------------------------
sym_links:
	cd $(RUNTIME_LIB); \
	chmod 755 ./makesymlinks.sh; \
	./makesymlinks.sh *.so.*; \
  chmod 777 *.so*; \
	cd $(CWD)
	
#------------------------------------------------------------------------------
# RULE: build_lvb
#------------------------------------------------------------------------------
build_lvb: $(LVB_OBJS)
	$(LD) $(LVB_LDFLAGS) $(LVB_OBJS) $(LIB_DIRS) $(LVB_LIBS) -o $(LVB_NAME).$(LVB_EXT)

#------------------------------------------------------------------------------
# RULE: install
#------------------------------------------------------------------------------
install:
	cp -f ./$(LVB_NAME).$(LVB_EXT) $(BINDING_VIS)

#------------------------------------------------------------------------------
# RULE: clean
#------------------------------------------------------------------------------
clean:
	rm -f *.o *.so.o *~ ./xml/*.o ./xml/*.so.o ./xml/*~
	rm -f $(LVB_NAME).$(LVB_EXT) 
	rm -f ../vis/$(LVB_NAME).$(LVB_EXT)
